# xcute CLI ツール技術仕様書

## システム概要

標準入力から読み込む各行をテンプレート引数として、指定されたコマンドを反復実行するCLIツール。プレースホルダー置換機能とコマンド実行制御機能を提供する。

## 技術仕様

### 実装言語・環境
- **言語**: Go 1.21+
- **バイナリ名**: `xcute`
- **対象プラットフォーム**: Linux, macOS, Windows (amd64, arm64)

### アーキテクチャ

#### 主要コンポーネント
1. **入力処理**: 標準入力の行単位読み込み
2. **プレースホルダー置換**: `{}`の置換処理
3. **コマンド実行**: `os/exec`パッケージによる子プロセス実行
4. **出力制御**: [fatih/color](https://github.com/fatih/color)による色付きログ出力

#### データフロー
```
標準入力 → 行読み込み → プレースホルダー置換 → コマンド実行 → 結果出力
```

## コマンド実行仕様

### 直接実行モード（デフォルト）

#### 動作仕様
- **実行方式**: コマンドを直接子プロセスとして実行
- **引数処理**: コマンドライン引数の構造を保持、各引数を独立して処理
- **プレースホルダー置換**: 各引数内で`{}`を入力行内容で置換
- **空白文字処理**: 入力に空白が含まれても単一引数として扱う

#### 動作例
```
入力引数: ["echo", "hello", "{}"]
標準入力行: "world test"
結果: ["echo", "hello", "world test"]
→ コマンド実行: echo hello "world test"
```

### シェル実行モード（`-c`オプション）

#### 動作仕様
- **実行方式**: シェル（`/bin/sh`）を通じてコマンド文字列を実行
- **引数制約**: `-c`オプション後に単一の文字列引数のみ受け入れ
- **プレースホルダー置換**: コマンド文字列全体で`{}`を一括置換
- **複雑コマンド**: パイプ、リダイレクト、条件実行などシェル機能利用可能

#### 動作例
```
入力引数: ['echo hello {} && echo processed {}']
標準入力行: "file.txt"
結果: 'echo hello file.txt && echo processed file.txt'
→ シェル実行: /bin/sh -c 'echo hello file.txt && echo processed file.txt'
```

## CLI インターフェース仕様

### フラグ定義

| フラグ | 型 | デフォルト値 | 説明 |
|--------|----|-----------|----|
| `-n` | bool | false | ドライランモード（実行せず表示のみ） |
| `-i` | bool | false | インタラクティブモード（実行前確認） |
| `-w` | bool | false | ターゲット表示（入力行を stderr に出力） |
| `-l` | bool | false | コマンドライン表示（実行前後の情報出力） |
| `-f` | bool | false | 強制継続（エラー時も処理継続） |
| `-t` | float64 | 0 | インターバル秒数（コマンド間の待機時間） |
| `-c` | bool | false | シェル実行モード |

### 実行フロー制御

#### ドライランモード (`-n`)
- コマンドを実行せず、実行予定のコマンドラインを標準出力に表示
- 各入力行に対する処理をスキップし、次の行へ進む
- デバッグや確認用途で使用

#### インタラクティブモード (`-i`)
- 各コマンド実行前にユーザー確認プロンプトを標準エラーに表示
- プロンプト形式: `Execute: <コマンド> [y/N] `
- `y` または `Y` 入力時のみコマンドを実行、その他の場合はスキップ

#### 強制継続モード (`-f`)
- コマンドが非ゼロ終了コードで終了してもプログラムを継続
- 通常モード: 最初のエラーで即座にプログラム終了
- 強制継続モード: 最後に発生したエラーの終了コードを記録し、全入力処理完了後に終了

## エラーハンドリング仕様

### 終了コード伝播
- **通常モード**: 最初のエラーで即座に終了、該当プロセスの終了コードを返す
- **強制継続モード**: 全処理完了後、最後のエラーコードを返す

### 特殊ケース処理

#### 空行処理
- 標準入力から空行を読み込んだ場合、該当行の処理をスキップ
- `-w`または`-l`オプションが有効な場合、空行であることを標準エラーに通知
- 通知形式: `[empty line]`（警告色で表示）

#### 入力読み込みエラー
- 標準入力の読み込み中にエラーが発生した場合、プログラムを異常終了
- エラーメッセージを標準エラーに出力して終了

## 出力制御仕様

### 色付け仕様
- **赤**: エラーメッセージ、非ゼロ終了コード表示
- **緑**: 成功メッセージ、ゼロ終了コード表示
- **黄**: 警告メッセージ、空行通知
- **青**: コマンドライン表示（`-l`オプション時）
- **シアン**: 入力行表示（`-w`オプション時）

### 出力ストリーム分離
- **stdout**: ドライラン時のコマンド表示、実行されるコマンドの標準出力
- **stderr**: ログ情報、エラーメッセージ、色付き制御情報

## 動作仕様（使用例）

### 基本動作
```bash
# 直接実行モード
echo -e "file1.txt\nfile2.txt" | xcute cat {}
# 実行: cat file1.txt, cat file2.txt

# 複数プレースホルダー
echo -e "apple\nbanana" | xcute echo "File: {} -> backup/{}"
# 実行: echo "File: apple -> backup/apple", echo "File: banana -> backup/banana"
```

### 実行モード別の動作
```bash
# シェル実行モード
find . -name "*.txt" | xcute -c 'wc -l {} && echo "processed {}"'
# 各ファイルに対してシェル経由で複合コマンドを実行

# 直接実行での引数保持
echo "file with spaces.txt" | xcute cp {} backup/
# 空白を含むファイル名も正しく単一引数として処理
```

### オプション動作
```bash
# ドライラン（実行せず表示のみ）
cat filelist.txt | xcute -n rm {}

# インタラクティブ確認
cat filelist.txt | xcute -i rm {}

# 詳細ログ（ターゲット表示 + コマンドライン表示）
cat filelist.txt | xcute -l -w cp {} backup/

# エラー発生時も継続
cat filelist.txt | xcute -f rm {}

# インターバル付き実行
cat urls.txt | xcute -t 0.5 curl -s {}

# オプション組み合わせ
cat files.txt | xcute -l -w -f -t 1 process {}
```

## テスト仕様

### 単体テスト対象
- `replacePlaceholders()`: プレースホルダー置換ロジック
- `App.processStdin()`: メイン処理フロー（モック化されたExecutorを使用）
- 各実行モードの動作検証
- エラーハンドリングの動作検証

### テストケース分類
1. **正常系**: 基本的なプレースホルダー置換と実行
2. **境界値**: 空行、空文字列、特殊文字を含む入力
3. **異常系**: コマンド失敗時の動作、不正な引数
4. **オプション組み合わせ**: 各フラグの組み合わせ動作

### モック化対象
- `CommandExecutor` インターフェース: 実際のコマンド実行をモック化
- `io.Reader/Writer`: 標準入出力のモック化
